name: Run PHP Web via Cloudflared

on:
  workflow_dispatch:   # cháº¡y thá»§ cÃ´ng trong tab Actions
  push:
    branches: [ main ] # hoáº·c khi push code (cÃ³ thá»ƒ bá» náº¿u khÃ´ng cáº§n)

jobs:
  run-php-server:
    runs-on: ubuntu-latest
    env:
      SITE_PORT: 5000
      ZIP_URL: https://github.com/hrjfjtjtntnfn/lode/releases/download/V.838383/new3.zip

    steps:
      - name: ğŸ“¦ Download new3.zip from GitHub release
        run: |
          echo "ğŸ”½ Downloading from $ZIP_URL ..."
          wget -q "$ZIP_URL" -O new3.zip
          unzip -q new3.zip
          # Náº¿u thÆ° má»¥c giáº£i nÃ©n lÃ  new3/new3, Ä‘Æ°a ná»™i dung ra ngoÃ i
          if [ -d "new3/new3" ]; then mv new3/new3/* new3/; fi
          echo "âœ… Extracted successfully."
          ls -al new3

      - name: âš™ï¸ Install PHP and Apache
        run: |
          sudo apt-get update -y
          sudo apt-get install -y apache2 php libapache2-mod-php unzip
          sudo a2enmod rewrite
          sudo service apache2 stop
          sudo mkdir -p /var/www/html
          sudo cp -r new3/* /var/www/html/
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 755 /var/www/html
          echo "âœ… Apache & PHP installed successfully."

      - name: ğŸ§  Configure Apache for .htaccess
        run: |
          sudo bash -c 'cat >/etc/apache2/sites-available/000-default.conf <<EOF
          <VirtualHost *:${SITE_PORT}>
              DocumentRoot /var/www/html
              <Directory /var/www/html>
                  AllowOverride All
                  Require all granted
              </Directory>
              ErrorLog \${APACHE_LOG_DIR}/error.log
              CustomLog \${APACHE_LOG_DIR}/access.log combined
          </VirtualHost>
          EOF'
          sudo sed -i "s/Listen 80/Listen ${SITE_PORT}/" /etc/apache2/ports.conf
          sudo apachectl configtest

      - name: ğŸš€ Start Apache server
        run: |
          echo "Starting Apache on port ${SITE_PORT}..."
          sudo apachectl -f /etc/apache2/apache2.conf -k start
          sleep 3
          curl -I http://localhost:${SITE_PORT} || true

      - name: â˜ï¸ Install cloudflared
        run: |
          echo "ğŸ“¥ Installing cloudflared..."
          sudo wget -q -O /usr/local/bin/cloudflared \
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          sudo chmod +x /usr/local/bin/cloudflared
          /usr/local/bin/cloudflared --version

      - name: ğŸŒ Start cloudflared tunnel and show public URL
        run: |
          echo "ğŸŒ Opening tunnel to http://localhost:${SITE_PORT} ..."
          nohup /usr/local/bin/cloudflared tunnel --url "http://localhost:${SITE_PORT}" --no-autoupdate > cloudflared.log 2>&1 &
          sleep 10
          if grep -Eo 'https?://[^ ]+trycloudflare.com' cloudflared.log | head -n1 > /tmp/public_url; then
            echo "âœ… Public URL:"
            cat /tmp/public_url
          else
            echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y URL. Log cloudflared:"
            head -n 100 cloudflared.log || true
            exit 1
          fi

          echo "ğŸ” Kiá»ƒm tra log Apache (náº¿u lá»—i 500)..."
          sudo tail -n 40 /var/log/apache2/error.log || true

          echo "ğŸ•’ Giá»¯ phiÃªn hoáº¡t Ä‘á»™ng 6000s Ä‘á»ƒ web online..."
          sleep 6000


      - name: ğŸ§¹ Stop Apache (cleanup)
        if: always()
        run: |
          echo "ğŸ§¹ Stopping Apache (cleanup)..."
          sudo apachectl -k stop || true
