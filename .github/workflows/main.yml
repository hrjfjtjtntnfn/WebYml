name: Deploy PHP Web via Cloudflared

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y unzip wget php php-cli php-curl php-xml

      - name: Download and unzip website
        run: |
          wget -O new3.zip "https://github.com/hrjfjtjtntnfn/lode/releases/download/V.838383/new3.zip"
          unzip -q new3.zip -d site
          echo "ğŸ“‚ Extracted to site/"
          ls -l site

      - name: Start PHP built-in web server (port 9000)
        run: |
          nohup bash -lc "cd site && php -S 0.0.0.0:9000" > server.log 2>&1 &
          sleep 5
          echo "âœ… PHP server started on port 9000"
          curl -I http://localhost:9000 || echo "âš ï¸ Local check failed"

      - name: Install cloudflared
        run: |
          echo "ğŸ“¥ Installing cloudflared..."
          wget -q -O /usr/local/bin/cloudflared \
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          sudo chmod +x /usr/local/bin/cloudflared
          cloudflared --version

      - name: Start cloudflared tunnel (ephemeral) and show public URL
        run: |
          echo "ğŸŒ Starting cloudflared tunnel to http://localhost:9000 ..."
          nohup /usr/local/bin/cloudflared tunnel --url http://localhost:9000 --no-autoupdate > cloudflared.log 2>&1 &
          sleep 8
          if grep -Eo 'https?://[^ ]+trycloudflare.com' cloudflared.log | head -n1 > /tmp/public_url; then
            echo "âœ… Public URL:"
            cat /tmp/public_url
          else
            echo "âš ï¸ KhÃ´ng tÃ¬m tháº¥y URL. Log cloudflared:"
            cat cloudflared.log
            exit 1
          fi
          echo "ğŸ•’ Giá»¯ phiÃªn hoáº¡t Ä‘á»™ng 6000s Ä‘á»ƒ web online..."
          sleep 6000
