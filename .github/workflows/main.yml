name: Deploy PHP Web via Apache + Cloudflared

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Install Apache + PHP
        run: |
          sudo apt-get update -y
          sudo apt-get install -y apache2 php libapache2-mod-php wget unzip

      - name: Download and unzip web files
        run: |
          wget -O new3.zip "https://github.com/hrjfjtjtntnfn/lode/releases/download/V.838383/new3.zip"
          unzip -q new3.zip -d site
          WEB_ROOT=$(find site -type f -name index.php | head -n1 | xargs dirname)
          echo "üìÇ Web root: $WEB_ROOT"
          echo "WEB_ROOT=$WEB_ROOT" >> $GITHUB_ENV

      - name: Configure Apache (custom httpd.conf)
        run: |
          mkdir -p $HOME/apache/conf
          cat > $HOME/apache/conf/httpd.conf <<'EOF'
          ServerRoot "/etc/apache2"
          Listen 9090
          ServerAdmin you@example.com
          ServerName localhost:9090

          LoadModule mpm_prefork_module /usr/lib/apache2/modules/mod_mpm_prefork.so
          LoadModule php_module /usr/lib/apache2/modules/libphp.so
          AddType application/x-httpd-php .php

          LoadModule authn_core_module /usr/lib/apache2/modules/mod_authn_core.so
          LoadModule authz_core_module /usr/lib/apache2/modules/mod_authz_core.so
          LoadModule access_compat_module /usr/lib/apache2/modules/mod_access_compat.so
          LoadModule mime_module /usr/lib/apache2/modules/mod_mime.so
          LoadModule log_config_module /usr/lib/apache2/modules/mod_log_config.so
          LoadModule env_module /usr/lib/apache2/modules/mod_env.so
          LoadModule headers_module /usr/lib/apache2/modules/mod_headers.so
          LoadModule setenvif_module /usr/lib/apache2/modules/mod_setenvif.so
          LoadModule unixd_module /usr/lib/apache2/modules/mod_unixd.so
          LoadModule status_module /usr/lib/apache2/modules/mod_status.so
          LoadModule autoindex_module /usr/lib/apache2/modules/mod_autoindex.so
          LoadModule dir_module /usr/lib/apache2/modules/mod_dir.so
          LoadModule alias_module /usr/lib/apache2/modules/mod_alias.so
          LoadModule rewrite_module /usr/lib/apache2/modules/mod_rewrite.so

          <Directory />
              AllowOverride none
              Require all denied
          </Directory>

          DocumentRoot "${WEB_ROOT}"
          <Directory "${WEB_ROOT}">
              Options Indexes FollowSymLinks
              AllowOverride All
              Require all granted
          </Directory>

          <IfModule dir_module>
              DirectoryIndex index.php index.html
          </IfModule>

          ErrorLog "/var/log/apache2/error_log"
          CustomLog "/var/log/apache2/access_log" common
          EOF

          echo "‚úÖ Apache config created at $HOME/apache/conf/httpd.conf"

      - name: Start Apache on port 9090
        run: |
          echo "üöÄ Starting Apache..."
          sudo apache2ctl -f $HOME/apache/conf/httpd.conf -DFOREGROUND &
          sleep 5
          echo "‚úÖ Apache started on http://localhost:9090"
          curl -I http://localhost:9090 || echo "‚ö†Ô∏è Cannot reach local server"

      - name: Install cloudflared
        run: |
          wget -q -O /usr/local/bin/cloudflared \
            https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          sudo chmod +x /usr/local/bin/cloudflared
          cloudflared --version

      - name: Start cloudflared tunnel (ephemeral)
        run: |
          echo "üåê Starting tunnel to http://localhost:9090 ..."
          nohup /usr/local/bin/cloudflared tunnel --url http://localhost:9090 --no-autoupdate > cloudflared.log 2>&1 &
          sleep 8
          if grep -Eo 'https?://[^ ]+trycloudflare.com' cloudflared.log | head -n1 > /tmp/public_url; then
            echo "‚úÖ Public URL:"
            cat /tmp/public_url
          else
            echo "‚ö†Ô∏è No public URL found. Debug log:"
            cat cloudflared.log
          fi
          echo "üïí Keeping alive for 6000s..."
          sleep 6000
